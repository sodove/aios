# AIOS — AI-First Operating System

**Дата:** 2026-02-20
**Статус:** Draft
**Лицензия:** MIT

---

## 1. Видение

Минимальная операционная система, в которой единственный интерфейс взаимодействия — чат с ИИ и браузер. ИИ является центральным агентом: управляет браузером, файлами, системными настройками и установкой программ. Пользователь общается с компьютером через естественный язык.

**Целевая аудитория:** личный прототип / proof of concept.

**Философия:** всё, что можно сделать через ИИ — делается через ИИ. Традиционные GUI-элементы (файловый менеджер, настройки, лаунчер) появляются только как fallback.

---

## 2. Архитектура

### 2.1 Базовая ОС

| Компонент | Решение |
|-----------|---------|
| Ядро | Linux (Debian/Ubuntu base) |
| Init-система | systemd (Debian default) |
| Display server | Wayland |
| Window manager | labwc (stacking WM, конфигурация XML) |
| Обновления | OTA с A/B partitions (атомарные обновления с откатом) |
| Пакетный менеджер | apt (для системы и пользовательских пакетов) |
| Целевые архитектуры | x86_64, ARM64 |

### 2.2 Компоненты AIOS

```
+--------------------------------------------------+
|                   labwc (Wayland WM)              |
|  +-------------------+  +---------------------+  |
|  |   AIOS Chat       |  |   Chromium Browser  |  |
|  |   (Iced / Rust)   |  |   (MCP-controlled)  |  |
|  |                    |  |                     |  |
|  |  [text input]      |  |  [web content]      |  |
|  |  [voice input]     |  |                     |  |
|  |  [rich cards]      |  |                     |  |
|  |  [file drop]       |  |                     |  |
|  +-------------------+  +---------------------+  |
|                                                    |
|  +----------------------------------------------+ |
|  |           Minimal Dock (установленные apps)   | |
|  +----------------------------------------------+ |
+--------------------------------------------------+
|              AIOS Agent Daemon (Rust)              |
|  +------+ +--------+ +-------+ +------+ +------+  |
|  | MCP  | | System | | File  | | RAG  | | TTS/ |  |
|  |Bridge| | Tools  | | Tools | |Memory| | STT  |  |
|  +------+ +--------+ +-------+ +------+ +------+  |
+--------------------------------------------------+
|         Linux Kernel (Debian/Ubuntu)               |
+--------------------------------------------------+
```

### 2.3 Ключевые процессы

| Процесс | Описание | Язык |
|---------|----------|------|
| `aios-agent` | Главный демон ИИ-агента: оркестрация tools, MCP, память, ИИ-провайдеры | Rust |
| `aios-chat` | Нативный GUI чат-клиент | Rust (Iced) |
| `aios-dock` | Минимальная панель запуска установленных приложений | Rust (Iced) |
| `aios-confirm` | Системные диалоги подтверждения действий ИИ | Rust (Iced) |
| `chromium` | Браузер, управляемый через Chrome MCP | Chromium |

---

## 3. ИИ-агент

### 3.1 Провайдеры LLM

Пользователь выбирает при установке (или позже через чат). Поддерживаемые:
- **Облачные:** Claude (Anthropic), GPT (OpenAI), Gemini (Google)
- **Локальные:** Ollama, llama.cpp (fallback при отсутствии интернета)

Режим: **гибрид** — облако когда есть сеть, локальная модель как fallback.

### 3.2 Capabilities (MCP Tools)

ИИ-агент предоставляет следующие tools:

**Браузер (Chrome MCP):**
- Открыть URL, навигация
- Чтение содержимого страницы
- Клик, ввод текста, заполнение форм
- Скриншоты, чтение DOM
- Управление вкладками

**Файловая система:**
- Чтение, создание, удаление, перемещение файлов
- Конвертация форматов (PDF, изображения, документы)
- Поиск по файлам

**Системные:**
- Wi-Fi: подключение, отключение, сканирование
- Bluetooth: пары, подключение устройств
- Яркость, громкость
- Информация о системе (диск, RAM, CPU, батарея)
- Обновление системы
- Установка/удаление пакетов (apt)

**Память:**
- Сохранение фактов о пользователе
- Поиск по истории диалогов
- Извлечение предпочтений

### 3.3 Система подтверждений

**Все действия ИИ требуют подтверждения** через системный модальный диалог (`aios-confirm`):

| Категория | Примеры | Диалог |
|-----------|---------|--------|
| Навигация | Открыть сайт, перейти по ссылке | Краткий: "Открыть google.com?" |
| Ввод данных | Заполнить форму, кликнуть кнопку | Подробный: показать что вводит и куда |
| Финансовые | Оплата, ввод карты | Критический: красный диалог, детали суммы |
| Системные | Установка пакета, смена Wi-Fi | Подробный: показать команду |
| Деструктивные | Удаление файлов, форматирование | Критический: двойное подтверждение |

**Принцип:** диалог показывает **реальную команду/действие**, а не описание от ИИ. Это защита от prompt injection — пользователь видит что реально произойдёт, а не что ИИ говорит.

### 3.4 Безопасность (рекомендация)

Проблема: ИИ с полным системным доступом — огромная attack surface. Prompt injection через веб-страницу может заставить ИИ выполнить вредоносные действия.

**Предлагаемая модель: "Transparent Execution"**

1. **Разделение intent и execution:** ИИ формирует intent (что сделать), но выполняет отдельный executor, который показывает реальные команды пользователю.

2. **Action audit log:** Все действия ИИ логируются в immutable лог (`/var/log/aios/actions.log`). Пользователь может просмотреть и откатить.

3. **Content isolation:** Контент веб-страниц обрабатывается в отдельном контексте от системных команд. ИИ-агент различает "данные из браузера" и "команды пользователя".

4. **Rate limiting:** Ограничение на количество деструктивных действий в единицу времени (не более 3 удалений файлов в минуту без дополнительного подтверждения).

5. **Rollback snapshots:** Перед деструктивными операциями — автоматический snapshot (btrfs snapshots или rsync).

---

## 4. Чат-клиент (aios-chat)

### 4.1 Технологии

| Компонент | Технология |
|-----------|-----------|
| Фреймворк | Iced (pure Rust) |
| Рендеринг | GPU (wgpu) |
| Протокол с агентом | Unix socket / gRPC |

### 4.2 Ввод

- **Текст:** стандартное текстовое поле с markdown-поддержкой
- **Голос:** кнопка записи, PTT (push-to-talk) или wake word
- **Файлы:** drag & drop / кнопка прикрепления
- **Скриншоты:** горячая клавиша для отправки скриншота в чат

### 4.3 Вывод

- **Текст:** markdown с syntax highlighting
- **Голос:** TTS-озвучка ответов ИИ
- **Интерактивные карточки (виджеты):**
  - Фиксированный набор встроенных виджетов (погода, таймер, калькулятор, календарь, системный мониторинг)
  - ИИ может генерировать кастомные карточки (HTML/JS, рендерятся в embedded WebView внутри Iced)
  - **Маркетплейс виджетов** (post-MVP): сообщество публикует виджеты, пользователь устанавливает через чат

### 4.4 Виджеты — техническая реализация

Виджет = JSON-манифест + HTML/CSS/JS bundle.

```
~/.aios/widgets/
  weather/
    manifest.json    # name, version, author, permissions
    index.html       # UI
    style.css
    script.js
```

ИИ вызывает виджет, передавая данные:
```json
{
  "widget": "weather",
  "data": { "city": "Moscow", "temp": -5, "condition": "snow" }
}
```

Виджет рендерится в sandboxed WebView внутри чата.

---

## 5. Голосовой ввод/вывод

### 5.1 STT (Speech-to-Text)

| Режим | Технология | Когда |
|-------|-----------|-------|
| Облако | Whisper API / Google STT | Есть интернет |
| Локально | whisper.cpp | Нет интернета / fallback |

### 5.2 TTS (Text-to-Speech)

| Режим | Технология | Когда |
|-------|-----------|-------|
| Облако | ElevenLabs / OpenAI TTS | Есть интернет |
| Локально | Piper TTS | Нет интернета / fallback |

---

## 6. Память ИИ

### 6.1 Архитектура

RAG (Retrieval-Augmented Generation) на базе локальной векторной БД.

| Компонент | Технология |
|-----------|-----------|
| Vector DB | Qdrant (embedded mode, Rust) или SQLite + pgvector-compatible extension |
| Embeddings | Локальная модель (all-MiniLM-L6-v2) или облачные |
| Хранилище фактов | SQLite (структурированные факты о пользователе) |
| История чатов | SQLite (полная история сообщений) |

### 6.2 Что хранится

- **Факты:** имя, адрес, предпочтения, привычки (извлекаются автоматически)
- **История:** все диалоги с timestamps
- **Контекст действий:** что ИИ делал (какие сайты открывал, файлы редактировал)

### 6.3 Многопользовательский режим

Каждый пользователь Linux = отдельный профиль ИИ:
- Своя векторная БД
- Своя история
- Свои факты и предпочтения
- Свой API-ключ провайдера LLM

Логин-экран стандартный (greetd / tuigreet или кастомный).

---

## 7. Браузер

### 7.1 Конфигурация

- **Движок:** Chromium (только Chromium-based, ограничение из-за Chrome MCP)
- **Выбор при установке:** Chromium (default), Brave, Vivaldi, ungoogled-chromium
- **Расширения:** поддерживаются (Chromium extension API)
- **MCP-интеграция:** Chrome MCP extension предустановлен, обеспечивает мост между ИИ-агентом и браузером

### 7.2 ИИ-управление браузером

Через Chrome MCP:
- `read_page` — чтение accessibility tree
- `find` — поиск элементов
- `computer` — клики, ввод, скролл
- `navigate` — навигация
- `javascript_tool` — выполнение JS
- `form_input` — заполнение форм

Все действия проходят через систему подтверждений (см. раздел 3.3).

---

## 8. Dock

Минимальная панель в нижней части экрана:
- Иконки: чат (всегда), браузер (всегда), + установленные пользователем приложения
- Индикаторы: запущенные приложения
- Системный трей: Wi-Fi, батарея, громкость, часы
- Реализация: Iced (Rust), Wayland layer-shell protocol

---

## 9. Установка

### 9.1 Процесс

1. Запись ISO на USB (Ventoy / dd)
2. Загрузка в Live-режим
3. Минимальный GUI-инсталлятор (Calamares или кастомный):
   - Язык
   - Диск и разметка (автоматическая с A/B partitions)
   - Пользователь + пароль
   - Выбор браузера (Chromium / Brave / ...)
   - Выбор ИИ-провайдера (Claude / GPT / Ollama / позже)
   - Ввод API-ключа (или пропустить)
4. Установка (~5 мин)
5. Перезагрузка в AIOS

### 9.2 Разметка диска

```
Partition 1: EFI (512MB)
Partition 2: System A (10GB, ext4, immutable)
Partition 3: System B (10GB, ext4, immutable)
Partition 4: User data (остаток, btrfs — для snapshots)
```

### 9.3 Образ для ARM (Raspberry Pi)

- Готовый .img для dd на SD/USB
- Первый запуск: мастер настройки через чат (Wi-Fi, пользователь, провайдер)

---

## 10. Fallback (offline-режим)

Когда нет интернета:
- **Чат:** работает на локальной модели (Ollama / llama.cpp), качество ниже
- **Файлы:** минимальный встроенный файл-менеджер (Iced) с просмотрщиком (PDF, изображения, текст)
- **Браузер:** работает с кэшированными страницами
- **STT/TTS:** локальные whisper.cpp + Piper

---

## 11. Обновления (OTA)

### 11.1 Механизм

- Два системных раздела: A (активный) и B (для обновления)
- Обновление скачивается в фоне на неактивный раздел
- При следующей перезагрузке — переключение на обновлённый раздел
- Если обновление сломано — автоматический откат на предыдущий раздел

### 11.2 Инструменты

- RAUC или SWUpdate для управления A/B partitions
- Кастомный сервер обновлений (или GitHub Releases для начала)

---

## 12. Стек технологий (сводка)

| Слой | Технология |
|------|-----------|
| Ядро | Linux (Debian-based) |
| WM | labwc (Wayland) |
| Чат-клиент | Rust + Iced |
| Dock | Rust + Iced |
| ИИ-агент | Rust |
| Браузер-контроль | Chrome MCP |
| LLM | Claude / GPT / Ollama (гибрид) |
| Память | Qdrant (embedded) + SQLite |
| STT | whisper.cpp / Whisper API |
| TTS | Piper / ElevenLabs |
| OTA | RAUC / SWUpdate |
| Лицензия | MIT |

---

## 13. Фазы разработки

### Phase 1 — MVP (Core)

- [ ] Минимальный Debian ISO с labwc
- [ ] aios-chat: текстовый ввод/вывод, подключение к 1 облачному провайдеру
- [ ] aios-agent: базовый MCP-сервер с tool use
- [ ] Chrome MCP интеграция: навигация, чтение страниц, клики
- [ ] aios-confirm: системные диалоги подтверждения
- [ ] Базовые системные tools: Wi-Fi, яркость, громкость
- [ ] Файловые tools: чтение, запись, удаление
- [ ] Минимальный dock: чат + браузер

### Phase 2 — Rich Experience

- [ ] Голосовой ввод (STT) и вывод (TTS)
- [ ] Интерактивные виджеты в чате (фиксированный набор)
- [ ] RAG-память (Qdrant + SQLite)
- [ ] Многопользовательский режим (логин-экран)
- [ ] Локальная модель (Ollama) как fallback
- [ ] Fallback файл-менеджер для offline
- [ ] Установка пакетов через ИИ

### Phase 3 — Platform

- [ ] OTA-обновления с A/B partitions
- [ ] ИИ-генерация кастомных виджетов (HTML/JS)
- [ ] Маркетплейс виджетов
- [ ] ARM64 образ (Raspberry Pi)
- [ ] Audit log + rollback snapshots
- [ ] Дополнительные ИИ-провайдеры

---

## 14. Риски и trade-offs

| Риск | Описание | Митигация |
|------|----------|-----------|
| Prompt injection | Веб-страница заставляет ИИ выполнить вредоносное действие | Transparent execution: диалог показывает реальную команду, не описание ИИ |
| Vendor lock-in LLM | Провайдер поднимает цены или закрывает API | Гибридный режим + локальная модель |
| Iced зрелость | Iced молодой фреймворк, возможны баги и missing features | Виджеты через embedded WebView, fallback на GTK если критично |
| Chromium-only | Ограничивает выбор браузера | Архитектура с абстрактным browser adapter, MCP — первая реализация |
| ARM + GPU | whisper.cpp и локальные LLM требуют GPU, на ARM (Pi) слабые | Облачные сервисы по умолчанию на ARM, локальные модели опциональны |
| OTA сложность | A/B partitions — нетривиальная инфраструктура | Начать с обычного apt, OTA в Phase 3 |
| Attack surface | ИИ с полным доступом — уязвимость | Audit log + rate limiting + snapshots + показ реальных команд |

---

## 15. Open Questions

1. **Оркестрация агента:** фреймворк пока не выбран. Варианты: свой минимальный на Rust, Claude Agent SDK (TypeScript), LangGraph (Python). Rust предпочтительнее для единого стека, но MCP SDK для Rust менее зрелый.

2. **Виджеты в Iced:** embedded WebView в Iced — нетривиальная задача. Возможно потребуется кастомный widget через wry/webview crate.

3. **Формат OTA-образов:** RAUC vs SWUpdate vs кастомный. Нужно исследовать совместимость с Debian.

4. **Размер ISO:** Chromium + Ollama + whisper.cpp + Iced = потенциально большой образ. Нужна оптимизация (модели качаются отдельно при первом запуске).
