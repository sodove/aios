# AIOS MVP -- Детальный пошаговый план реализации

**Дата:** 2026-02-20
**Стадия:** Plan
**Статус:** Ожидает одобрения

---

## Текущее состояние

- Проект пустой (только `/specs/`)
- Rust 1.93.1, Docker 28.5.2 доступны на macOS
- ISO собирается в Docker (live-build требует Linux)
- Целевая архитектура: x86_64

---

## Milestones и шаги

### Milestone 0: Scaffold -- Workspace и инфраструктура

#### Step 0.1: Cargo Workspace + `aios-common`

**Создать:**
```
aios/
  Cargo.toml                    # workspace root
  .gitignore
  LICENSE                       # MIT
  crates/
    aios-common/
      Cargo.toml
      src/
        lib.rs
        ipc/
          mod.rs
          transport.rs          # Unix socket client/server
          protocol.rs           # Length-prefixed JSON codec
        types/
          mod.rs
          message.rs            # ChatMessage, Role, Content
          tool.rs               # ToolCall, ToolResult
          trust.rs              # TrustLevel enum
          config.rs             # AiosConfig, ProviderConfig
        error.rs                # thiserror error types
        audit.rs                # AuditEntry types
```

**Ключевые типы:**
- `TrustLevel { User, System, WebContent, Memory }`
- `IpcMessage` -- envelope для всех IPC-сообщений
- `ChatMessage { role, content, trust_level, timestamp }`
- `ToolCall / ToolResult`
- `ConfirmRequest / ConfirmResponse`
- `AuditEntry`
- `LengthPrefixedCodec` -- 4-byte BE length + JSON
- `IpcServer / IpcClient`

**Зависимости:** serde, serde_json, tokio, thiserror, anyhow, uuid, chrono, tracing

**Зависит от:** ничего | **Блокирует:** все остальные шаги

---

#### Step 0.2: Scaffold всех бинарных crates

Все 7 crates подключены в workspace, каждый зависит от aios-common, каждый компилируется.

```
crates/
  aios-agent/    (bin)
  aios-chat/     (bin)
  aios-dock/     (bin)
  aios-confirm/  (bin)
  aios-mcp/      (lib)
  aios-memory/   (lib)
  aios-voice/    (lib)
```

**Зависит от:** 0.1 | **Блокирует:** Milestone 1-5

---

#### Step 0.3: Docker build environment для Debian ISO

```
iso/
  Dockerfile                # Debian Bookworm + live-build
  build-iso.sh              # Сборка ISO внутри Docker
  config/
    auto/config
    package-lists/aios.list.chroot   # labwc, greetd, pipewire, chromium, fonts
    hooks/live/
      01-setup-greetd.hook.chroot
      02-setup-labwc.hook.chroot
      03-setup-pipewire.hook.chroot
```

**Зависит от:** ничего (параллельно с 0.1) | **Блокирует:** 5.1

---

#### Step 0.4: GitHub Actions CI

```
.github/workflows/
  ci.yml      # cargo fmt, clippy, test, build
  iso.yml     # Docker + live-build (manual trigger)
```

**Зависит от:** 0.1 | **Блокирует:** ничего (поддерживающий)

---

### Milestone 1: IPC Transport + Agent skeleton

#### Step 1.1: IPC Transport -- полная реализация

- `IpcServer` -- слушает Unix socket (`/run/user/{uid}/aios-agent.sock`)
- `IpcClient` -- подключается к сокету
- `LengthPrefixedCodec` -- encode/decode
- Стриминг: `IpcMessage::StreamChunk { request_id, delta, done }`
- Reconnect logic: 500ms retry, до 10 попыток
- Unit-тесты codec + integration тест server-client

**Зависит от:** 0.1 | **Блокирует:** 1.2, 2.1, 3.1, 3.2, 4.1

---

#### Step 1.2: aios-agent skeleton -- демон с IPC

```
crates/aios-agent/src/
  main.rs       # tokio::main, setup tracing
  server.rs     # IpcServer loop
  router.rs     # Route IpcMessage к handlers
  config.rs     # ~/.config/aios/agent.toml
  state.rs      # AgentState
```

Echo-режим (без LLM). Config:
```toml
[provider]
type = "openai"
api_key = ""
model = "gpt-4o"

[agent]
socket_path = "/run/user/1000/aios-agent.sock"
audit_log = "/var/log/aios/actions.log"
max_destructive_per_minute = 3
```

**Зависит от:** 1.1 | **Блокирует:** 1.3

---

#### Step 1.3: LLM Provider abstraction + провайдеры

```
crates/aios-agent/src/llm/
  mod.rs       # LlmProvider trait
  openai.rs    # async-openai 0.33
  claude.rs    # misanthropic 0.5.1
  ollama.rs    # ollama-rs 0.3.4 (stub)
  types.rs     # LlmRequest, LlmResponse, StreamDelta
```

```rust
#[async_trait]
pub trait LlmProvider: Send + Sync {
    async fn complete(&self, req: &LlmRequest) -> Result<LlmResponse>;
    async fn complete_stream(&self, req: &LlmRequest) -> Result<Pin<Box<dyn Stream<Item = Result<StreamDelta>>>>>;
    fn supports_tools(&self) -> bool;
    fn name(&self) -> &str;
}
```

System prompt template в `system_prompt.txt`.

**Зависит от:** 1.2 | **Блокирует:** 2.3

---

### Milestone 2: Chat client + end-to-end чат

#### Step 2.1: aios-chat -- базовый UI (Iced)

```
crates/aios-chat/src/
  main.rs
  app.rs            # AiosChat: update/view/subscription
  theme.rs          # Темная тема
  views/
    chat_view.rs    # Список сообщений + input bar
    message_bubble.rs
    input_bar.rs
  state.rs          # messages, input_text, connection_status
  ipc_client.rs     # Подключение к agent
```

UI layout: header, message list (scrollable), input bar (attach + mic + text + send).

**Зависит от:** 0.2, 1.1 | **Блокирует:** 2.2

---

#### Step 2.2: Markdown rendering и syntax highlighting

- `iced::widget::markdown` для рендеринга
- Code blocks с syntax highlighting (syntect / встроенное в Iced)
- Кликабельные ссылки

**Зависит от:** 2.1 | **Блокирует:** 2.3

---

#### Step 2.3: End-to-end текстовый чат

Полный поток:
1. User -> aios-chat -> `IpcMessage::ChatRequest` -> aios-agent
2. Agent -> LLM provider (streaming)
3. Agent -> `IpcMessage::StreamChunk` -> aios-chat (token by token rendering)
4. `IpcMessage::StreamDone` -> финализация

Error handling: connection retry, API errors, timeout 30s.

**Зависит от:** 1.3, 2.1, 2.2 | **Блокирует:** Milestone 3

---

### Milestone 3: MCP Tools + Confirm dialog

#### Step 3.1: MCP Tool Framework (aios-mcp)

```
crates/aios-mcp/src/
  lib.rs
  registry.rs        # ToolRegistry
  executor.rs        # ToolExecutor
  definitions.rs     # ToolDefinition (JSON Schema)
  tools/
    file_read.rs, file_write.rs, file_delete.rs, file_list.rs, file_search.rs
    shell_exec.rs
    wifi_list.rs, wifi_connect.rs
    brightness.rs, volume.rs
    system_info.rs
    open_url.rs
```

```rust
#[async_trait]
pub trait Tool: Send + Sync {
    fn definition(&self) -> ToolDefinition;
    fn trust_requirement(&self) -> TrustRequirement; // None, Confirm, DoubleConfirm
    async fn execute(&self, args: Value, ctx: &ToolContext) -> Result<ToolResult>;
}
```

TrustRequirement levels:
- `None` -- read-only (file_read, wifi_list, system_info)
- `Confirm` -- modifying (file_write, wifi_connect, brightness, volume)
- `DoubleConfirm` -- destructive (file_delete, shell_exec)

**Зависит от:** 1.2 | **Блокирует:** 3.2, 3.3, 4.2

---

#### Step 3.2: aios-confirm -- диалог подтверждения

Отдельный процесс (Iced), получает ConfirmRequest по IPC, показывает диалог:
- Обычный: описание + команда + [Отмена] / [Разрешить]
- Критический: красный, ввод "DELETE" для подтверждения

Timeout: 60s -> авто-отмена. Agent НЕ может программно подтвердить.

**Зависит от:** 1.1, 0.2 | **Блокирует:** 3.3

---

#### Step 3.3: Tool Execution Pipeline + Audit Log

Pipeline: LLM -> tool_use -> check trust_requirement -> confirm if needed -> audit log -> execute -> audit result -> return to LLM.

Rate limiting: max 3 destructive/min.

Audit log format (JSON Lines, append-only):
```json
{"ts":"...","action":"file_write","args":{...},"trust":"User","approved":true,"result":"ok"}
```

**Зависит от:** 3.1, 3.2, 1.3 | **Блокирует:** 3.4

---

#### Step 3.4: Tool cards в Chat UI

Визуализация tool calls в чате:
- Серая карточка: "Вызов: file_read /path"
- Желтая: "Ожидание подтверждения..."
- Зеленая: результат (collapsible)
- Красная: "Отклонено пользователем"

**Зависит от:** 2.3, 3.3 | **Блокирует:** Milestone 5

---

### Milestone 4: Dock + Chrome MCP

#### Step 4.1: aios-dock -- минимальная панель

```
crates/aios-dock/src/
  main.rs           # iced_layershell
  app.rs
  views/dock_bar.rs, app_icon.rs, system_tray.rs
  launcher.rs       # std::process::Command
```

Layout: [Chat] [Chrome] ... | WiFi | Vol | Bat | 15:30

Wayland layer-shell: Anchor Bottom+Left+Right, Exclusive zone 48px, Layer Top.
System tray обновляется каждые 5 секунд.

**Зависит от:** 1.1, 0.2 | **Блокирует:** 5.1

---

#### Step 4.2: Chrome MCP Bridge

```
crates/aios-mcp/src/tools/browser/
  mod.rs, navigate.rs, read_page.rs, find_element.rs
  click.rs, type_text.rs, screenshot.rs, get_page_text.rs
crates/aios-mcp/src/chrome_mcp_client.rs  # rmcp 0.16.0
```

AIOS tools -> rmcp MCP calls -> Chrome MCP extension -> Chromium.
Все browser actions через aios-confirm.

**Зависит от:** 3.1, 3.3 | **Блокирует:** 5.1

---

#### Step 4.3: Chromium autostart и labwc конфигурация

```
iso/config/includes.chroot/
  etc/labwc/rc.xml, autostart, environment
  etc/chromium.d/aios-policy.json
  usr/share/applications/*.desktop
```

autostart: aios-agent -> aios-dock, aios-chat, chromium.
Keybinds: Super+Enter -> chat, Super+B -> browser.

**Зависит от:** 0.3 | **Блокирует:** 5.1

---

### Milestone 5: Integration + ISO build

#### Step 5.1: Cross-compilation (macOS -> Linux x86_64)

```
Cross.toml
Makefile    # build-linux, install-iso, build-iso, run-qemu
```

`cross build --release --target x86_64-unknown-linux-gnu` или сборка внутри Docker.

**Зависит от:** 0.3, все бинарные crates | **Блокирует:** 5.4

---

#### Step 5.2: Systemd user services

```
iso/config/includes.chroot/etc/systemd/user/
  aios-agent.service, aios-chat.service, aios-dock.service, aios-confirm.service
  aios.target
```

Labwc autostart для первого запуска, systemd для restart policy.

**Зависит от:** 4.3 | **Блокирует:** 5.4

---

#### Step 5.3: First Boot Experience (OOBE)

OOBE внутри aios-chat (не отдельное приложение):
1. Проверка наличия конфига
2. Приветственный чат: выбор провайдера, API-ключ
3. Сохранение конфига -> нормальный режим

**Зависит от:** 2.3 | **Блокирует:** 5.4

---

#### Step 5.4: Финальная сборка ISO + QEMU тест

1. Cross-compile бинарники
2. Копирование в includes.chroot
3. build-iso.sh в Docker
4. QEMU: загрузка -> labwc -> dock + chat -> OOBE -> чат работает

**Зависит от:** 5.1, 5.2, 5.3, все предыдущие | **Блокирует:** ничего (финал)

---

## Dependency Graph

```
Step 0.1 ──┬── Step 0.2 ──────────────────────────────────────┐
           ├── Step 0.4 (CI, independent)                     │
           └── Step 1.1 ──┬── Step 1.2 ── Step 1.3 ──────┐   │
                          ├── Step 2.1 ── Step 2.2 ───┐   │   │
                          ├── Step 3.1 ──────────────┐ │   │   │
                          ├── Step 3.2 ─────────────┐│ │   │   │
                          └── Step 4.1 ──────────── ││ │   │   │
                                                    vv v   v   │
                                              Step 2.3 (e2e)   │
                                                    │          │
Step 0.3 ── Step 4.3 ──────────────────────┐   Step 3.3       │
                                           │     │  │          │
                                           │   Step 3.4       │
                                           │     │            │
                                           │   Step 4.2       │
                                           │     │            │
                                      Step 5.1 ──┤            │
                                           │     │            │
                                      Step 5.2   Step 5.3     │
                                           │     │            │
                                           v     v            │
                                         Step 5.4 ◄───────────┘
```

---

## Рекомендуемый порядок выполнения

| # | Step | Описание |
|---|------|----------|
| 1 | 0.1 | aios-common: types + IPC codec |
| 2 | 0.2 + 0.3 | Scaffold crates + Docker ISO env (параллельно) |
| 3 | 0.4 | GitHub Actions CI |
| 4 | 1.1 | IPC Transport полная реализация |
| 5 | 1.2 | Agent skeleton |
| 6 | 1.3 | LLM providers (OpenAI + Claude) |
| 7 | 2.1 | Chat UI base (Iced) |
| 8 | 2.2 | Markdown + syntax highlighting |
| 9 | 2.3 | End-to-end текстовый чат |
| 10 | 3.1 | MCP Tool Framework + system tools |
| 11 | 3.2 | aios-confirm dialog |
| 12 | 3.3 | Tool execution pipeline + audit |
| 13 | 3.4 | Tool cards в Chat UI |
| 14 | 4.1 | Dock (iced_layershell) |
| 15 | 4.2 | Chrome MCP bridge |
| 16 | 4.3 | labwc/chromium config |
| 17 | 5.1 | Cross-compilation setup |
| 18 | 5.2 | Systemd services |
| 19 | 5.3 | OOBE (first boot) |
| 20 | 5.4 | ISO build + QEMU test |

---

## Ключевые архитектурные решения

1. **Star topology IPC** -- все через aios-agent, никаких прямых связей
2. **aios-confirm -- отдельный процесс** -- agent не может подтвердить сам себя
3. **Length-prefixed JSON** -- 4 байта длины + JSON, debug-friendly
4. **LlmProvider trait** -- абстракция для добавления провайдеров
5. **ToolRegistry + TrustRequirement** -- каждый tool декларирует уровень подтверждения
6. **OOBE внутри Chat** -- не отдельное приложение, а режим aios-chat
7. **labwc autostart для MVP** -- systemd для restart policy
